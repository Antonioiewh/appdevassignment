{% extends "Operatorbase.html"%}
{% block title %}Dashboard - Operator Dashboard{% endblock %}
{% from "includes/_formHelper.html" import render_field %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    #categoryChart {
      max-width: 70%;
      height: 350px;
      margin-left: 5%;
      margin-top: -1%;
      }
</style>
<body>
    <h1 class="display-4">Dashboard</h1>
    <div style="width: 65%;" class="p-3 d-flex align-items-center justify-content-evenly"> <!--still a wip-->
        <a href="/dashboard/users" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Users</a>
        <a href="/dashboard/listings" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Listings</a>
        <a href="#" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Transactions</a>
        <a href="/dashboard/feedbacks" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Feedback</a>
        <a href="/dashboard/reports" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Reports</a>
        <a href="/dashboard/operatoractions" style="text-decoration:none; color:black; font-weight:bold" class="m-auto">Operator actions</a>
        <a href="/dashboard/OperatorDashboard" style="text-decoration:none; color:rgb(9, 223, 98); font-weight:bold" class="m-auto">Customer dashboard</a>
    </div>
    <div style="display: flex; align-items: flex-start; gap: 20px;">
      <!-- Table Container -->
      <div style="flex: 1; max-width: 40%; height: 400px;">
          <canvas id="topSellersChart" height="300" width="450"></canvas>
      </div>
        <!-- Chart Container -->
      <div style="flex: 1;">
            <canvas id="categoryChart"></canvas>
      </div>
    </div>
    <br><p><strong>Average days for a listing to sell:</strong> {{ avg_days_to_sell }} days</p>
    <p><strong>Average days for listing in Electronics to sell:</strong> {{ electronics_day_avg }} days</p>
    <p><strong>Average days for listing in Books to sell:</strong> {{ books_day_avg }} days</p>
    <p><strong>Average days for listing in Fashion sell:</strong> {{ fashion_day_avg }} days</p>
    <p><strong>Average days for listing in Entertainment to sell:</strong> {{ entertainment_day_avg }} days</p>
    <p><strong>Average days for listing in Misc to sell:</strong> {{ misc_day_avg }} days</p>
</body>
<script>
    const categories = ["Electronics", "Books", "Fashion", "Entertainment", "Misc"];
    const soldCounts = [{{ cat_electronics }}, {{ cat_books }}, {{ cat_fashion }}, {{ cat_entertainment }}, {{ cat_misc }}];
    const ctx = document.getElementById('categoryChart').getContext('2d');
    const categoryChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: categories,
            datasets: [{
                data: soldCounts,
                backgroundColor: ['#1F77B4', '#FF7F0E', '#2CA02C', '#D62728', '#9467BD'], // 5 visually distinct colors
                borderColor: '#FFFFFF',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right'
                },
                title: {
                    display: true,
                    text: 'Products Sold by Category',
                    font: {
                        size: 18,
                        weight: 'bold'
                    },
                    color: '#000',
                    align: 'center'
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(tooltipItem) {
                            let value = tooltipItem.raw;
                            let category = categories[tooltipItem.dataIndex];
                            let total = soldCounts.reduce((sum, count) => sum + count, 0);
                            let percentage = ((value / total) * 100).toFixed(2);
                            return `${category}: ${value} sold (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

</script>
<script>
    const topSellerUsernames = [{% for user in top10_seller_dic.keys() %} "{{ name_dic[user] }}", {% endfor %}];
    const topSellerSoldCounts = [{% for user, sold_count in top10_seller_dic.items() %} {{ sold_count }}, {% endfor %}];
    const topSellerUserIDs = [{% for user in top10_seller_dic.keys() %} "{{ user }}", {% endfor %}];
    const topSellerRatings = [{% for user in top10_seller_dic.keys() %} "{{ rating_dic[user] }}", {% endfor %}];
    const ctx2 = document.getElementById('topSellersChart').getContext('2d');
    const topSellersChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: topSellerUsernames, // X-axis (Usernames)
            datasets: [{
                label: 'Products Sold',
                data: topSellerSoldCounts, // Y-axis (Products Sold)
                backgroundColor: ['#1F77B4', '#FF7F0E', '#2CA02C', '#D62728', '#9467BD', '#8C564B', '#E377C2', '#7F7F7F', '#BCBD22', '#17BECF'],
                borderColor: '#FFFFFF',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false // Hides default legend
                },
                title: {
                    display: true,
                    text: 'Top 10 Sellers',
                    font: {
                        size: 18,
                        weight: 'bold'
                    },
                    color: '#000',
                    align: 'center'
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(tooltipItem) {
                            let index = tooltipItem.dataIndex;
                            let sold = topSellerSoldCounts[index];
                            let userID = topSellerUserIDs[index];
                            let rating = topSellerRatings[index];
                            return [`Products Sold: ${sold}`, `User ID: ${userID}`, `Rating: ${rating}`];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Username',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Products Sold',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                }
            }
        }
    });
</script>

{% endblock %}
{% from "includes/_formHelper.html" import render_field %}
