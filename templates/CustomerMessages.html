{% extends "Customerbase.html"%}
{% block title %}Messages{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
      xmlns="http://www.w3.org/1999/html">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.1/lazysizes.min.js" async></script>
<script>
    window.onload = function() {
        scrollToBottom();
    };
    function scrollToBottom() {
        const messageBox = document.querySelector('.message-box');
        messageBox.scrollTop = messageBox.scrollHeight;
    }
</script>

<!-- error Modal for Invalid Receiver ID -->
{% if show_error_modal %}
<script>
    window.onload = function() {
        new bootstrap.Modal(document.getElementById('invalidReceiverModal')).show();
        var modalElement = document.getElementById('invalidReceiverModal');
        modalElement.addEventListener('hidden.bs.modal', function () {
            window.location.href = "{{ url_for('messages') }}";
          });
    }
</script>
{% endif %}
<style>
    body {
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    .chat-container {
        display: flex;
        height: 80vh;
        padding: 0;
        margin-left: -5.5%;
    }
    .left-column {
        width: 25%;
        background-color: #f1f1f1;
        padding: 10px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        overflow-x: hidden;
        height: 106.3%;
    }
    .right-column {
        width: 75%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        margin-bottom: -5%;
    }
    .message-box {
        flex-grow: 1;
        overflow-y: auto;
        margin-right: -7%;
        display: flex;
        flex-direction: column;
        gap: 7px;
    }

    .message {
        position: relative; /* positioning the ellipsis inside each message */
        background-color: #ddd;
        padding: 10px;
        border-radius: 5px;
        min-height: 6%;
        width: 45%;
        flex-shrink: 0; /* prevent messages from shrinking */
    }

    /* Ellipsis Icon (Three vertical dots) */
    .ellipsis-container {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        visibility: visible;
    }

    .ellipsis {
        width: 6px;
        height: 6px;
        background-color: #d3d3d3;
        border-radius: 50%;
        margin-bottom: 3px;
    }

    .ellipsis-container.active .ellipsis {
        background-color: #a9a9a9;
    }

    /* dropdown Menu */
    .dropdown-menu2 {
        display: none; /* hidden by default */
        position: absolute;
        top: 0;
        right: 30px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-width: 120px;
        z-index: 1000;
    }

    .dropdown-menu2 ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .dropdown-menu2 ul li {
        padding: 5px 5px;
    }

    .dropdown-menu2 ul li a {
        text-decoration: none;
        color: #333;
        display: block;
        padding: 6px;
    }

    .dropdown-menu2 ul li a:hover {
        background-color: #f1f1f1;

    }

    /* show dropdown when ellipsis is clicked */
    .message.show-dropdown .dropdown-menu2 {
        display: block;
    }

    .new-chat-btn {
        margin-bottom: 10px;
        margin-left: 68%;
    }

    .message_class {
        margin-left: -2%;
        margin-top: -18%;
        padding-bottom: 3%;
    }

    hr {
        border-top: 2px solid #28242c;
        width: 110%;
        opacity: 1;
        margin-left: -5%;
        margin-top: -3%;
    }

    .recent {
        margin-top: -3%;
    }

    .placeholder_text {
        background-color: #d3d3d3;
        color: #28242c;
        border: 2px solid #28242c;
        border-radius: 8px;
        padding: 10px;
        font-size: 1.5em;
        width: 31.5%;
        margin: auto;
        margin-top: 25%;
    }

    .messagebox {
        margin-bottom: -1%;
        margin-top: 0.5%;

    }

    #sendbutton {
        margin-left: 98%;
        padding: 1.2%;
        font-size: 1.3em;
        margin-top: -18.5%;
    }

    #content {
        width: 89%;
    }

    #sendButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    pre{
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 15px;
        font-family: sans-serif;
        padding: 3px;
    }

    #hr2{
        margin-top: 0.47%;
        margin-left: -1.1%;
    }

    .time{
        font-size: 65%;
        margin-top: -3.8%;
        margin-bottom: -1.1%;
    }

    #shiftup{
        margin-top: -1%;
        margin-bottom: -0.5%;
    }
    .message.sent {
        background-color: #4CAF50;
        color: white;
        text-align: left;
        align-self: flex-end;
        margin-right: 1%;
    }
    .message.received {
        background-color: #f1f1f1;
        text-align: left;
        align-self: flex-start;
    }
    .profile-picture img {
        width: 52px;
        height: 52px;
        border-radius: 50%; /* circle */
        object-fit: cover; /* crop properly */
        border: 2px solid #ccc;
    }
    .chat-container11 {
        padding-left: 7px;
        margin-top: -3px;
        padding-top: 3px;
        padding-right: 7px;
        transition: background-color 0.3s ease;
        border-radius: 10px;
        width: fit-content;
    }

    .chat-container11:hover {
        background-color: #d3d3d3;
        cursor: pointer;
    }

    #camera-button {
        margin-top: -14%;
        margin-left: 90.75%;
        padding: 1.5%;
        padding-left: 2%;
        padding-right: 2%;
    }

    .thumbnail_box {
        display: flex;
        flex-direction: column;
        background-color: #d3d3d3;
        margin-bottom: 5px;
        width: 109.1%;
        margin-left: -1%;
        border-radius: 5px;
    }

    .thumbnail-image {
        max-width: auto;
        max-height: 40px;
        margin-bottom: 5px;
        margin-left: 5px;
        margin-top: 5px;

    }

    .thumbnail-text {
        max-width: 100%;
        padding: 7px;
        margin-top: 10px;
        font-size: 14px;
    }
    .remove-file-btn:hover {
        color: #ff0000; /* Change color on hover (e.g., red) */
        cursor: pointer; /* Change cursor to indicate it's clickable */
    }
    #listings div:hover {
        background-color: #f0f0f0;
        cursor: pointer;
    }
    #viewlistingbutton{
        width: 100%;
        border: none;
        border-radius: 5px;
        padding-top: 4px;
        padding-bottom: 4px;
        margin-top: 10px;
    }
    #viewlistingbutton:hover{
        background-color: #d3d3d3;
    }
    .replymessage{
        display: flex;
        flex-direction: column;
        width: 109.1%;
        margin-left: -1%;
        padding: 6px;
        padding-left: 10px;
        border-radius: 5px;
    }

</style>

<body>
    <div class="container">
        <div class="chat-container">
            <!-- Left column for recent chats -->
            <div class="left-column">
                <button class="btn btn-primary new-chat-btn" data-bs-toggle="modal" data-bs-target="#newChatModal">New Chat</button>
                <h1 class="message_class">Messages</h1>
                <hr>
                <h3 class="recent">Recent Chats</h3>
                <ul class="list-group">
                    {% if recent_chats %}
                        {% for chat in recent_chats %}
                            <a href="{{ url_for('messages', receiver_id=chat['receiver_id']) }}" style="text-decoration: none; color: inherit;" id="{{ chat['receiver_id'] }}">
                                <li class="list-group-item" style="height: 60px; display: flex;
                                    {% if selected_chat and selected_chat['receiver_id'] == chat['receiver_id'] %}
                                        background-color: lightgray;  /* Dark Gray */
                                    {% endif %}">
                                    <div class="profile-picture" style="display: flex; align-items: center;"><img src="static/profilepics/customer{{ chat['receiver_id'] }}.jpg" onerror="this.onerror=null; this.src='static/profilepics/placeholder.png';" alt="Profile Picture"></div>
                                    <div style="margin-left: 15px; margin-top: -4px;" class="user_name111">User {{ chat['receiver_id'] }}</div>
                                </li>
                            </a>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item">No recent chats</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Right column for chat window -->
            <div class="right-column">
                {% if selected_chat %}
                <div class="chat-container11"><h3>Chat with <span class="forjavascript222"><b>{{ selected_chat['receiver_id'] }}</b></span></h3></div>
                    <hr id="hr2">
                    <div class="message-box">
                        {% for message in selected_chat['messages'] %}
                            <div class="message {{ message.type }}" id="{{ message.message_id }}" data-message-content="{{ message.content }}">
                                <div id="shiftup" ><b>{{ 'To' if message.type == 'sent' else 'From' }}:</b>
                                {{ message.receiver_id if message.type == 'sent' else message.sender_id }}</div>
                                {% if message.status == "deleted" %}
                                    <pre><i style="color: lightgray;">This message has been deleted</i></pre>
                                    <div class="time"><small>{{ message.timestamp }}</small></div>
                                {% elif message.status == "edited" %}
                                {% if message.reply_content is not none %}
                                    {% if message.sender_reply_id|string == message.sender_id|string and message.sender_reply_id|string == current_sessionID|string %}
                                        <div style="background-color: #8fbc8f; padding: 5px; margin-top: 12px; border-radius: 10px; padding-left: 10px; padding-right: 10px;">{{ message.reply_content|safe}}</div>
                                        <script>console.log("{{ message.sender_id }}")</script>
                                    {% else %}
                                        <div style="background-color: #d3d3d3; padding: 5px; margin-top: 12px; border-radius: 10px; padding-left: 10px; padding-right: 10px; color:black;">{{ message.reply_content|safe }}</div>
                                    {% endif %}
                                {% endif %}
                                {% if message.type2 in ["text+pic", "picture"] %}
                                    <img src="{{ url_for('static', filename='messagepics/' + message.message_id + message.extension) }}"
                                         alt="Sent Image" style="max-width: 100%; height: auto; border-radius: 3px; margin-top: 3%;" class="lazyload">
                                {% elif message.type2 == "listingpic" %}
                                    <img src="{{ url_for('static', filename='listingpics/' + 'listing' + message.listing_id + message.extension) }}" onerror="this.onerror=null; this.src='static/listingpics/notfound.png';"
                                         alt="Sent Image" style="max-width: 100%; height: auto; border-radius: 3px; margin-top: 3%;" class="lazyload">
                                {% endif %}
                                <pre>{{ message.content | safe }}</pre>
                                <div class="time"><small>{{ message.timestamp }}</small></div>
                                <div class="time" style="margin-left: 94%;" id="editcheck"><small>Edited</small></div>
                                <div class="ellipsis-container">
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                </div>
                                <div class="dropdown-menu2">
                                    <ul>
                                        {% if message.type == 'sent' %}
                                            {% if message.type2 != 'picture' and message.type2 != 'listingpic' %}
                                                <li><a href="#" class="edit-option" data-message-id="{{ message.message_id }}" data-message-content="{{ message.content }}">Edit</a></li>
                                            {% endif %}
                                            {% if message.type2 != 'listingpic' %}
                                                <li><a href="#" class="delete-option" data-message-id="{{ message.message_id }}">Delete</a></li>
                                            {% endif %}
                                        {% endif %}
                                        <li><a href="#" class="reply-option">Reply</a></li>
                                    </ul>
                                </div>
                                {% else %}
                                {% if message.reply_content is not none %}
                                    {% if message.sender_reply_id|string == message.sender_id|string and message.sender_reply_id|string == current_sessionID|string %}
                                        <div style="background-color: #8fbc8f; padding: 5px; margin-top: 12px; border-radius: 10px; padding-left: 10px; padding-right: 10px;">{{ message.reply_content|safe }}</div>
                                        <script>console.log("{{ message.sender_id }}")</script>
                                    {% else %}
                                        <div style="background-color: #d3d3d3; padding: 5px; margin-top: 12px; border-radius: 10px; padding-left: 10px; padding-right: 10px; color:black;">{{ message.reply_content|safe }}</div>
                                    {% endif %}
                                {% endif %}
                                {% if message.type2 in ["text+pic", "picture"] %}
                                    <img src="{{ url_for('static', filename='messagepics/' + message.message_id + message.extension) }}"
                                         alt="Sent Image" style="max-width: 100%; height: auto; border-radius: 3px; margin-top: 3%;" class="lazyload">
                                {% elif message.type2 == "listingpic" %}
                                    <img src="{{ url_for('static', filename='listingpics/' + 'listing' + message.listing_id + message.extension) }}" onerror="this.onerror=null; this.src='static/listingpics/notfound.png';"
                                         alt="Sent Image" style="max-width: 100%; height: auto; border-radius: 3px; margin-top: 3%;" class="lazyload">
                                {% endif %}
                                <pre>{{ message.content | safe }}</pre>
                                <div class="time"><small>{{ message.timestamp }}</small></div>
                                <div class="ellipsis-container">
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                </div>
                                <div class="dropdown-menu2">
                                    <ul>
                                        {% if message.type == 'sent' %}
                                            {% if message.type2 != 'picture' and message.type2 != 'listingpic' %}
                                                <li><a href="#" class="edit-option" data-message-id="{{ message.message_id }}" data-message-content="{{ message.content }}">Edit</a></li>
                                            {% endif %}
                                            {% if message.type2 != 'listingpic' %}
                                                <li><a href="#" class="delete-option" data-message-id="{{ message.message_id }}">Delete</a></li>
                                            {% endif %}
                                        {% endif %}
                                        <li><a href="#" class="reply-option" data-message-id="{{ message.message_id }}" data-message-content="{{ message.content }}" data-message-sender = "{{ message.sender_id }}">Reply</a></li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="placeholder_text">
                        Select a chat to get started!
                    </div>
                {% endif %}

                {% if selected_chat %}
                <div class="messagebox">
                    <div id="listings" style="max-height: 40px; overflow-y: auto; overflow-x: hidden; border:1px solid #ccc; display: none; margin-bottom: 5px;" data-ids='{{ listings_dict.keys()|list|tojson }}'>
                        {% for id, listing in listings_dict.items() %}
                        <div style="padding: 1px; margin-left: 5px;" class="unfiltered-item" data-id="{{ id }}" data-title="{{ listing.get_title() }}">@{{ id ~ " " ~ listing.get_title() }} </div>
                        {% endfor %}
                        <script>
                            document.addEventListener("DOMContentLoaded", function() {
                                const listingsDiv = document.getElementById("listings");
                                listingsDiv.addEventListener("click", function(event) {
                                    if (event.target.classList.contains("unfiltered-item")) {
                                        const inputField = document.getElementById("content");  // Assuming the input field has the id 'content'
                                        const id = event.target.getAttribute("data-id"); // Get the id from the data-id attribute
                                        const title = event.target.getAttribute("data-title"); // Get the title from the data-title attribute
                                        const textBeforeAt = inputField.value.substring(0, inputField.selectionStart);
                                        const textAfterAt = inputField.value.substring(inputField.selectionEnd);
                                        const lastAtIndex = textBeforeAt.lastIndexOf('@');
                                        const updatedText = textBeforeAt.substring(0, lastAtIndex) + `@${id} ${title}` + textAfterAt;
                                        inputField.value = updatedText;
                                        inputField.focus();
                                        inputField.selectionStart = inputField.selectionEnd = updatedText.length;
                                        listingsDiv.style.display = "none";
                                    }
                                });
                            });
                        </script>
                    </div>
                    <div id="replymessage" class="replymessage" style="display: none; position: relative;background-color: #c0c0c0;">
                        <b>Replying to:</b><br>
                        <div id="reply-message-content"></div>
                        <span class="btn-close remove-reply-btn" style="position: absolute; top:5px; right:5px; color: #333; cursor: pointer;" onclick="removeReplyPreview()"></span>
                    </div>
                    <div id="thumbnail" class="thumbnail_box"></div>
                        <form method="POST" id="message-form" enctype="multipart/form-data">
                            <input type="hidden" name="receiver_id" id="textinput" value="{{ selected_chat['receiver_id'] }}">
                            <input type="hidden" name="reply" id="replyvalue" value="False">
                            <input type="hidden" name="replymessagecontent" id="replymessageid" value="">
                            <input type="hidden" name="sender_ID" id="sender_ID" value="">
                            <label for="content"></label>
                            <textarea id="content" name="content" required placeholder="Type a message..." autofocus></textarea><br><br>
                            <input type="file" id="image-upload" name="image" accept=".jpg, .png, .jpeg" style="display: none;">
                            <button type="button" class="btn btn-secondary" id="camera-button">
                                <i class="bi bi-camera"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" id="sendbutton" disabled>Send</button>
                        </form>
                    </div>

                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for creating a new chat -->
    <div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChatModalLabel">Start a New Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/messages" method="POST" id="receiveridform222">
                    <div class="mb-3">
                        <label for="receiver_id" class="form-label">Enter User ID:</label>
                        <input type="text" class="form-control" id="receiver_id" name="receiver_id" oninput="limitDigits()" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="startChatButton">Start Chat</button>
                </form>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal for displaying error (Invalid Receiver ID) -->
    <div class="modal fade" id="invalidReceiverModal" tabindex="-1" aria-labelledby="invalidReceiverModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invalidReceiverModalLabel">Invalid User ID</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="error-message">{{ error_message }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Do you want to confirm deleting this message?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirm</button>
            </div>
        </div>
    </div>
</div>
<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userProfileModalLabel">User {{ selected_chat['receiver_id'] }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Profile Picture -->
                <div class="profile-picture">
                    <img src="static/profilepics/customer{{ selected_chat['receiver_id'] }}.jpg" onerror="this.onerror=null; this.src='static/profilepics/placeholder.png';" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;">
                </div>
                <!-- Buttons below Profile Picture -->
                <div class="mt-3" style="text-align: center;">
                    <button class="btn btn-primary" id="goToProfileButton">Profile</button>
                    <button class="btn btn-danger" id="blockUserButton" style="margin-left: 10px; margin-right: 10px;">Block User</button>
                    <button class="btn btn-danger" id="deletechat111" data-receiver-id="{{ selected_chat['receiver_id'] }}">Delete chat</button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Edit modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editmessage222">
                    <div class="mb-3">
                        <label for="editInput" class="form-label">Enter new message:</label>
                        <input type="text" class="form-control" id="editInput" name="editInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="confirmedit">Confirm</button>
                </form>
            </div>
        </div>
    </div>
    </div>
    <script>
        // Function to toggle the visibility of the dropdown menu
        document.querySelectorAll('.ellipsis-container').forEach((ellipsisContainer) => {
            ellipsisContainer.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent click from bubbling to parent message container
                const message = this.closest('.message');
                message.classList.toggle('show-dropdown');
            });
        });

        // Close dropdown when clicking anywhere outside the message
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.dropdown-menu2').forEach(dropdown => {
                if (!dropdown.contains(event.target) && !dropdown.previousElementSibling.contains(event.target)) {
                    dropdown.style.display = 'none'; // Hide the dropdown if clicked outside
                    dropdown.previousElementSibling.classList.remove('active'); // Remove 'active' class
                }
            });
        });

        // Send the message when the Enter key is pressed (without Shift)
        const messageInput = document.getElementById('content');
        const sendButton = document.getElementById('sendbutton');
        const messageForm = document.getElementById('message-form');

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line from being added
                if (messageInput.value.trim() !== "") {
                    messageForm.submit(); // Submit the form to send the message
                }
            }
        });

        // Enable send button when there is text in the message input
        messageInput.addEventListener('input', function() {
            sendButton.disabled = messageInput.value.trim() === "";
        });

        // Open dark gray colour when dropdown box is open
        document.querySelectorAll('.ellipsis-container').forEach(ellipsisContainer => {
            ellipsisContainer.addEventListener('click', function(event) {
                // Prevent the click event from propagating further
                event.stopPropagation();

                // First, close any open dropdowns and reset their ellipses to the default state
                document.querySelectorAll('.ellipsis-container').forEach(container => {
                    if (container !== this) {
                        container.classList.remove('active'); // Remove 'active' class
                        const dropdownMenu = container.nextElementSibling;
                        dropdownMenu.style.display = 'none'; // Hide the dropdown menu
                    }
                });

                // Toggle the 'active' class on the clicked ellipsis container
                this.classList.toggle('active');

                // Toggle the display of the dropdown menu for the clicked ellipsis
                const dropdownMenu = this.nextElementSibling;
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
        });

        document.querySelectorAll('.delete-option').forEach(option => {
            option.addEventListener('click', function(event) {
                event.preventDefault();  // Prevent the default action of the delete link

                // Get the message ID from the clicked delete option
                const messageId = this.getAttribute('data-message-id');

                // Show the confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                modal.show();  // Show the modal

                // Set the message ID on the 'Confirm Delete' button
                document.getElementById('confirmDeleteButton').setAttribute('data-message-id', messageId);

                // Confirm delete action when clicking on the 'Confirm Delete' button
                document.getElementById('confirmDeleteButton').addEventListener('click', function() {
                    modal.hide();  // Hide the modal after deletion is confirmed
                    const messageId = this.getAttribute('data-message-id');
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`).closest('.message');
                    const preElement = messageElement.querySelector('pre');
                    preElement.innerHTML = "<i style='color: lightgray;'>This message has been deleted</i>";
                    const ellipsisContainer = messageElement.querySelector('.ellipsis-container');
                    ellipsisContainer.style.display = 'none';
                    const imageElement = messageElement.querySelector('img');
                    if (imageElement) {
                        imageElement.remove(); // Remove the image from the UI
                    }

                    fetch('/delete_message', {
                        method: 'POST',  // Use POST for modifying data
                        headers: {
                            'Content-Type': 'application/json',  // Tell the server we're sending JSON
                        },
                        body: JSON.stringify({
                            message_id: messageId  // Send the message ID as part of the request body
                        })
                    })
                    .then(response => response.json())  // Assuming the backend returns JSON
                    .then(data => {
                        if (data.success) {
                            // Optionally, remove the message from the UI if deletion is successful
                            document.querySelector(`[data-message-id='${messageId}']`).closest('.message').remove();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });


                });
            });
        });
        //function to shorten text to ...
        function truncateName(name, maxLength) {
            if (name.length > maxLength) {
                return name.slice(0, maxLength) + "...";
            }
            return name;
        }
        //shortening usernames if they exceed 20 characters
        const userNames = document.querySelectorAll(".user_name111");
        for (let i = 0; i < userNames.length; i++) {
            const element = userNames[i];  // Get the current element in the loop
            const fullName = element.textContent;  // Get the current text of the element
            const truncatedName = truncateName(fullName, 20);  // Limit name to 20 characters (or any other number)
            element.textContent = truncatedName;  // Update the element's text with the truncated name
        }
        const chatContainer = document.querySelector(".forjavascript222");
        const userNames2 = chatContainer.textContent;
        const truncatedName2 = truncateName(userNames2, 60);
        chatContainer.textContent = truncatedName2;

        //user profile preview
        document.querySelector('.chat-container11').addEventListener('click', function() {
            // Open the modal
            const userProfileModal = new bootstrap.Modal(document.getElementById('userProfileModal'));
            userProfileModal.show();
        });

        document.getElementById('goToProfileButton').addEventListener('click', function() {
            window.location.href = `/profile/{{ selected_chat['receiver_id'] }}`;
        });

        document.getElementById('blockUserButton').addEventListener('click', function() {

        });
        document.getElementById('deletechat111').addEventListener('click', function () {
            const receiverId = this.getAttribute('data-receiver-id');
            const modalElement = document.getElementById('userProfileModal'); // Replace with your modal's ID
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement); // Get the Bootstrap modal instance
                modalInstance.hide(); // Hide the modal
            }
            fetch('/delete_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ receiver_id: receiverId }),
            })
            window.location.href = "/messages";
        });

        function limitDigits() {
            const input = document.getElementById("receiver_id");
            if (input.value.length > 15) {
                input.value = input.value.slice(0, 15);
            }
            input.value = input.value.replace(/\D/g, "");
        }

        let latestMessageContent = "";
        document.querySelectorAll('.edit-option').forEach(option => {
            option.addEventListener('click', function(event) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();

                const messageId = this.getAttribute('data-message-id');
                let messageContent = this.getAttribute('data-message-content');
                const messageInput = document.getElementById('editInput');
                const confirmEditButton = document.getElementById('confirmedit');

                messageInput.value = latestMessageContent || messageContent.trim();

                confirmEditButton.replaceWith(confirmEditButton.cloneNode(true));
                const newConfirmEditButton = document.getElementById('confirmedit');

                // Update the button state based on the input field
                const updateButtonState = function() {
                    const inputValue = messageInput.value.trim();  // Get the trimmed value of the input field
                    if (inputValue === messageContent.trim()) {
                        newConfirmEditButton.disabled = true;  // Disable button if input is same as original content
                    } else if (inputValue) {
                        newConfirmEditButton.disabled = false;  // Enable the button if there's input
                    } else {
                        newConfirmEditButton.disabled = true;  // Disable button if input is empty
                    }
                };
                updateButtonState();
                messageInput.addEventListener('input', function() {
                    updateButtonState();
                });

                const newClickHandler = function(e) {
                    e.preventDefault();
                    const messageInputValue = messageInput.value.trim();
                    if (messageInputValue === "") {
                        return;
                    }
                    console.log("Message Input Value:", messageInput.value);
                    latestMessageContent = messageInputValue;
                    fetch('/edit_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messageId: messageId,
                            message: messageInput.value.trim()
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response:', data);

                        // Update the DOM to show the new message content
                        const messageDiv = document.getElementById(messageId);
                        if (messageDiv) {
                            const preTag = messageDiv.querySelector('pre');
                            if (preTag) {
                                preTag.textContent = messageInput.value.trim();
                            }
                            const editCheckTag = messageDiv.querySelector('#editcheck');
                            // Add the "Edited" tag
                            if (!editCheckTag) {
                                const editedTag = document.createElement('div');
                                editedTag.classList.add('time', 'editTag');
                                editedTag.style.marginLeft = '94%';
                                editedTag.innerHTML = '<small>Edited</small>';
                                messageDiv.appendChild(editedTag);
                            }
                        }

                        modal.hide(); // Close the modal
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                };
                newConfirmEditButton.addEventListener('click', newClickHandler);
            });
        });
    document.getElementById('camera-button').addEventListener('click', function() {

        const fileInput = document.getElementById('image-upload');
        fileInput.click();  // Trigger the file input when the camera button is clicked
    });
    document.getElementById('image-upload').addEventListener('change', function() {
        const fileInput = this;
        const thumbnailDiv = document.getElementById('thumbnail');
        const sendButton = document.getElementById('sendbutton');
        const contentTextarea = document.getElementById('content');
        const validExtensions = ['.jpg', '.jpeg', '.png'];  // Valid image extensions
        // Clear the thumbnail div whenever a new file is selected
        thumbnailDiv.innerHTML = '';

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0]; // Get the first selected file
            const fileNameStr = file.name.toLowerCase();
            const fileExtension = fileNameStr.slice(fileNameStr.lastIndexOf('.'));
            const container = document.createElement('div');
            container.classList.add('thumbnail-container');
            container.style.position = 'relative'
            if (!validExtensions.includes(fileExtension)) {
                alert('Invalid file type. Please upload a PNG, JPG, or JPEG image.');
                fileInput.value = '';  // Clear the file input
                thumbnailDiv.innerHTML = '';  // Clear the preview
                sendButton.disabled = true;  // Disable the send button
                contentTextarea.setAttribute('required', 'required'); // Set the textarea to required again
                return;  // Exit the function to prevent further processing
            }

            // Create image element for preview
            const imageElement = document.createElement('img');
            imageElement.src = URL.createObjectURL(file); // Create a URL for the image
            imageElement.classList.add('thumbnail-image'); // Apply styling

            // Create the text for the file name
            const fileName = document.createElement('span');
            fileName.classList.add('thumbnail-text');
            fileName.textContent = file.name;

            // Create the remove button (X)
            const removeButton = document.createElement('span');
            removeButton.classList.add('btn-close' ,'remove-file-btn');
            removeButton.style.position = 'absolute'; // Position the close button
            removeButton.style.top = '5px'; // Adjust the top position
            removeButton.style.right = '5px'; // Adjust the right position
            removeButton.style.color = '#333';

            // When the remove button is clicked, clear the file input and the preview
            removeButton.addEventListener('click', function() {
                fileInput.value = ''; // Clear the file input
                thumbnailDiv.innerHTML = ''; // Clear the preview
                sendButton.disabled = true; // Disable the send button
                contentTextarea.setAttribute('required', 'required'); // Set the textarea to required again
            });

            // Append the image, filename, and remove button to the container
            container.appendChild(imageElement);
            container.appendChild(fileName);
            container.appendChild(removeButton);

        //document.getElementById('image-upload').click(); // Trigger file input when the camera button is clicked
    //});

    //document.getElementById('image-upload').addEventListener('change', function() {
        //if (this.files.length > 0) {
            //alert("File selected: " + this.files[0].name); // Show an alert (you can replace this with a preview)
        //}
    //});


            // Append the container to the thumbnail div
            thumbnailDiv.appendChild(container);

            // Enable the send button once the file is selected
            sendButton.disabled = false;
            contentTextarea.removeAttribute('required'); // Remove the required attribute from the textarea
        }
    });
    {% if listings_dict %}
        const originalListingsHTML = `
            {% for id, listing in listings_dict.items() %}
                <div style="padding: 1px; margin-left: 5px;" class="unfiltered-item" data-id="{{ id }}" data-title="{{ listing.get_title() }}">@{{ id ~ " " ~ listing.get_title() }} </div>
            {% endfor %}
        `;
        const listingIds = {{ listings_dict.keys() | list | tojson }};
    {% endif %}
    const listingsDiv = document.getElementById("listings");
    listingsDiv.innerHTML = originalListingsHTML;
    {% if titles_dict %}
        titles_dict = {{ titles_dict | tojson }}
    {% endif %}
    document.getElementById("content").addEventListener("input", function () {
        const inputField = this;
        const listingsDiv = document.getElementById("listings");
        const cursorPosition = inputField.selectionStart;
        const textBeforeCursor = inputField.value.substring(0, cursorPosition);
        const match = textBeforeCursor.match(/@(\d+)$/);
        const isMultipleAtSymbols = (textBeforeCursor.match(/@/g) || []).length > 1;
        const isAtSymbolPresent = textBeforeCursor.includes("@");
        const textAfterAt = textBeforeCursor.split('@')[1];
        const isSpaceAfterAt = textAfterAt?.includes(" ");
        const isLetterPresent = /[a-zA-Z]/.test(textAfterAt);

        listingsDiv.style.display = (
            isAtSymbolPresent &&  // Check if '@' is typed
            !isSpaceAfterAt &&    // Ensure no space after '@'
            !isLetterPresent &&     // Ensure no letters after '@'
            !isMultipleAtSymbols
        ) ? "block" : "none";

        if (match) {
            const typedId = parseInt(match[1]); // Extract the number after '@'

            // Filter the listing IDs that start with the typed number
            const filteredIds = listingIds.filter(id => id.toString().startsWith(match[1].toString()));
            listingsDiv.innerHTML = ""; // Clear the previous list

            // If there are matching results, show them
            if (filteredIds.length > 0) {
                filteredIds.forEach(id => {
                    let div = document.createElement('div'); // Use let here to define the div
                    div.style.padding = "1px";
                    div.style.marginLeft = "5px";
                    div.textContent = `@${id} ${titles_dict[id]}`;
                    div.classList.add("filtered-item");
                    div.addEventListener("click", function () {
                       const textBeforeAt = inputField.value.substring(0, inputField.selectionStart);
                       const textAfterAt = inputField.value.substring(inputField.selectionEnd);
                       const lastAtIndex = textBeforeAt.lastIndexOf('@');
                       const updatedText = textBeforeAt.substring(0, lastAtIndex) + `@${id} ${titles_dict[id]}` + textAfterAt;
                       inputField.value = updatedText;
                       inputField.focus();
                       inputField.selectionStart = inputField.selectionEnd = updatedText.length;
                       listingsDiv.style.display = "none";
                    });
                    listingsDiv.appendChild(div);
                });
            } else {
                listingsDiv.innerHTML = "<div style='padding: 1px; margin-left: 5px;'>No matches found</div>";
            }
        } else {
            // If no number is typed after '@', restore the original listingsDiv state
            listingsDiv.innerHTML = originalListingsHTML;
        }
    });
    document.querySelectorAll('.reply-option').forEach(button => {
        button.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            const messageContent = this.getAttribute('data-message-content');
            const senderID = this.getAttribute('data-message-sender');
            document.getElementById('replymessage').style.display = 'block';
            shortenedmessage = truncateName(messageContent, 80)
            document.getElementById('reply-message-content').innerHTML = shortenedmessage;
            document.getElementById('replyvalue').value = "True";
            document.getElementById('replymessageid').value = shortenedmessage;
            document.getElementById('sender_ID').value = senderID;
            const inputField = document.getElementById("content");  // Assuming the input field has the id 'content'
            inputField.focus();
            const dropdown = this.closest('.dropdown-menu2'); // Get the closest dropdown menu
            if (dropdown) {
                dropdown.style.display = 'none';  // Hide the dropdown
                dropdown.previousElementSibling.classList.remove('active');  // Remove active class
            }
            const currentSessionID = {{ current_sessionID|string }};
            if (senderID != currentSessionID) {
                document.getElementById('replymessage').style.backgroundColor = '#c0c0c0';  // Gray for receiver's message
            } else {
                document.getElementById('replymessage').style.backgroundColor = '#8fbc8f';  // Green for sender's message
            }
        });
    });
    function removeReplyPreview() {
        document.getElementById('reply-message-content').innerHTML = '';
        document.getElementById('replymessage').style.display = 'none';
        document.getElementById('replyvalue').value = "False";
        document.getElementById('replymessageid').value = '';
        document.getElementById('sender_ID').value = '';
        document.getElementById('replymessage').style.backgroundColor = '';
    }
    </script>
</body>

{% endblock %}
{% from "includes/_formHelper.html" import render_field %}