{% extends "Customerbase.html"%}
{% block title %}Messages{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
      xmlns="http://www.w3.org/1999/html">
<!-- error Modal for Invalid Receiver ID -->
{% if show_error_modal %}
<script>
    window.onload = function() {
        new bootstrap.Modal(document.getElementById('invalidReceiverModal')).show();
        var modalElement = document.getElementById('invalidReceiverModal');
        modalElement.addEventListener('hidden.bs.modal', function () {
            window.location.href = "{{ url_for('messages') }}";
          });
    }

</script>
{% endif %}
<style>
    body {
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    .chat-container {
        display: flex;
        height: 80vh;
        padding: 0;
        margin-left: -5.5%;
    }
    .left-column {
        width: 25%;
        background-color: #f1f1f1;
        padding: 10px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        overflow-x: hidden;
        height: 106.3%;
    }
    .right-column {
        width: 75%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        margin-bottom: -5%;
    }
    .message-box {
        flex-grow: 1;
        overflow-y: auto;
        margin-right: -7%;
        display: flex;
        flex-direction: column;
        gap: 7px;
    }

    .message {
        position: relative; /* positioning the ellipsis inside each message */
        background-color: #ddd;
        padding: 10px;
        border-radius: 5px;
        min-height: 6%;
        width: 45%;
        flex-shrink: 0; /* prevent messages from shrinking */
    }

    /* Ellipsis Icon (Three vertical dots) */
    .ellipsis-container {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
        visibility: visible;
    }

    .ellipsis {
        width: 6px;
        height: 6px;
        background-color: #d3d3d3;
        border-radius: 50%;
        margin-bottom: 3px;
    }

    .ellipsis-container.active .ellipsis {
        background-color: #a9a9a9;
    }

    /* dropdown Menu */
    .dropdown-menu2 {
        display: none; /* hidden by default */
        position: absolute;
        top: 0;
        right: 30px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-width: 120px;
        z-index: 1000;
    }

    .dropdown-menu2 ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .dropdown-menu2 ul li {
        padding: 5px 5px;
    }

    .dropdown-menu2 ul li a {
        text-decoration: none;
        color: #333;
        display: block;
        padding: 6px;
    }

    .dropdown-menu2 ul li a:hover {
        background-color: #f1f1f1;

    }

    /* show dropdown when ellipsis is clicked */
    .message.show-dropdown .dropdown-menu2 {
        display: block;
    }

    .new-chat-btn {
        margin-bottom: 10px;
        margin-left: 68%;
    }

    .message_class {
        margin-left: -2%;
        margin-top: -18%;
        padding-bottom: 3%;
    }

    hr {
        border-top: 2px solid #28242c;
        width: 110%;
        opacity: 1;
        margin-left: -5%;
        margin-top: -3%;
    }

    .recent {
        margin-top: -3%;
    }

    .placeholder_text {
        background-color: #d3d3d3;
        color: #28242c;
        border: 2px solid #28242c;
        border-radius: 8px;
        padding: 10px;
        font-size: 1.5em;
        width: 31.5%;
        margin: auto;
        margin-top: 25%;
    }

    .messagebox {
        margin-top: 1%;
        margin-bottom: 1.5%
    }

    #sendbutton {
        margin-left: 98%;
        padding: 1.2%;
        font-size: 1.3em;
        margin-top: -14%;
    }

    #content {
        width: 89%;
    }

    #sendButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    pre{
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 15px;
        font-family: sans-serif;
        padding: 3px;
    }

    #hr2{
        margin-top: 0.47%;
        margin-left: -1.1%;
    }

    .time{
        font-size: 65%;
        margin-top: -3.8%;
        margin-bottom: -1.1%;
    }

    #shiftup{
        margin-top: -1%;
        margin-bottom: -0.5%;
    }
    .message.sent {
        background-color: #4CAF50;
        color: white;
        text-align: left;
        align-self: flex-end;
        margin-right: 1%;
    }
    .message.received {
        background-color: #f1f1f1;
        text-align: left;
        align-self: flex-start;
    }
    .profile-picture img {
        width: 52px;
        height: 52px;
        border-radius: 50%; /* circle */
        object-fit: cover; /* crop properly */
        border: 2px solid #ccc;
    }
    .chat-container11 {
        padding-left: 7px;
        margin-top: -3px;
        padding-top: 3px;
        padding-right: 7px;
        transition: background-color 0.3s ease;
        border-radius: 10px;
        width: fit-content;
    }

    .chat-container11:hover {
        background-color: #d3d3d3;
        cursor: pointer;
    }

</style>

<body>
    <div class="container">
        <div class="chat-container">
            <!-- Left column for recent chats -->
            <div class="left-column">
                <button class="btn btn-primary new-chat-btn" data-bs-toggle="modal" data-bs-target="#newChatModal">New Chat</button>
                <h1 class="message_class">Messages</h1>
                <hr>
                <h3 class="recent">Recent Chats</h3>
                <ul class="list-group">
                    {% if recent_chats %}
                        {% for chat in recent_chats %}
                            <a href="{{ url_for('messages', receiver_id=chat['receiver_id']) }}" style="text-decoration: none; color: inherit;" id="{{ chat['receiver_id'] }}">
                                <li class="list-group-item" style="height: 60px; display: flex;
                                    {% if selected_chat and selected_chat['receiver_id'] == chat['receiver_id'] %}
                                        background-color: lightgray;  /* Dark Gray */
                                    {% endif %}">
                                    <div class="profile-picture" style="display: flex; align-items: center;"><img src="static/profilepics/hermos.jpg" alt="Profile Picture"></div>
                                    <div style="margin-left: 15px; margin-top: -4px;" class="user_name111">User {{ chat['receiver_id'] }}</div>
                                </li>
                            </a>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item">No recent chats</li>
                    {% endif %}
                </ul>
            </div>

            <!-- Right column for chat window -->
            <div class="right-column">
                {% if selected_chat %}
                <div class="chat-container11"><h3>Chat with <span class="forjavascript222"><b>{{ selected_chat['receiver_id'] }}</b></span></h3></div>
                    <hr id="hr2">
                    <div class="message-box">
                        {% for message in selected_chat['messages'] %}
                            <div class="message {{ message.type }}" id="{{ message.message_id }}">
                                <div id="shiftup" ><b>{{ 'To' if message.type == 'sent' else 'From' }}:</b>
                                {{ message.receiver_id if message.type == 'sent' else message.sender_id }}</div>
                                {% if message.status == "deleted" %}
                                    <pre><i style="color: lightgray;">This message has been deleted</i></pre>
                                    <div class="time"><small>{{ message.timestamp }}</small></div>
                                {% elif message.status == "edited" %}
                                <pre>{{ message.content }}</pre>
                                <div class="time"><small>{{ message.timestamp }}</small></div>
                                <div class="time" style="margin-left: 94%;" id="editcheck"><small>Edited</small></div>
                                {% else %}
                                <pre>{{ message.content }}</pre>
                                <div class="time"><small>{{ message.timestamp }}</small></div>
                                {% endif %}
                                <!-- Ellipsis Icon (Three dots) and Dropdown -->
                                <div class="ellipsis-container">
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                    <div class="ellipsis"></div>
                                </div>
                                <div class="dropdown-menu2">
                                    <ul>
                                        {% if message.type == 'sent' %}
                                            <li><a href="#" class="edit-option" data-message-id="{{ message.message_id }}" data-message-content="{{ message.content }}">Edit</a></li>
                                            <li><a href="#" class="delete-option" data-message-id="{{ message.message_id }}">Delete</a></li>
                                        {% endif %}
                                        <li><a href="#" class="reply-option">Reply</a></li>
                                    </ul>
                                </div>

                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="placeholder_text">
                        Select a chat to get started!
                    </div>
                {% endif %}

                {% if selected_chat %}
                <div class="messagebox">
                    <form method="POST" id="message-form">
                        <input type="hidden" name="receiver_id" id="textinput" value="{{ selected_chat['receiver_id'] }}">
                        <label for="content"></label>
                        <textarea id="content" name="content" required placeholder="Type a message..." autofocus></textarea><br><br>
                        <button type="submit" class="btn btn-primary" id="sendbutton" disabled>Send</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for creating a new chat -->
    <div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChatModalLabel">Start a New Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/messages" method="POST" id="receiveridform222">
                    <div class="mb-3">
                        <label for="receiver_id" class="form-label">Enter User ID:</label>
                        <input type="text" class="form-control" id="receiver_id" name="receiver_id" oninput="limitDigits()" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="startChatButton">Start Chat</button>
                </form>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal for displaying error (Invalid Receiver ID) -->
    <div class="modal fade" id="invalidReceiverModal" tabindex="-1" aria-labelledby="invalidReceiverModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invalidReceiverModalLabel">Invalid User ID</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="error-message">{{ error_message }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Do you want to confirm deleting this message?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirm</button>
            </div>
        </div>
    </div>
</div>
<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userProfileModalLabel">User {{ selected_chat['receiver_id'] }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Profile Picture -->
                <div class="profile-picture">
                    <img id="profilePicture" src="static/profilepics/hermos.jpg" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;">
                </div>
                <!-- Buttons below Profile Picture -->
                <div class="mt-3" style="text-align: center;">
                    <button class="btn btn-primary" id="goToProfileButton">Profile</button>
                    <button class="btn btn-danger" id="blockUserButton" style="margin-left: 10px; margin-right: 10px;">Block User</button>
                    <button class="btn btn-danger" id="deletechat111" data-receiver-id="{{ selected_chat['receiver_id'] }}">Delete chat</button>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Edit modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editmessage222">
                    <div class="mb-3">
                        <label for="editInput" class="form-label">Enter new message:</label>
                        <input type="text" class="form-control" id="editInput" name="editInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="confirmedit">Confirm</button>
                </form>
            </div>
        </div>
    </div>
    </div>
    <script>
        // Function to toggle the visibility of the dropdown menu
        document.querySelectorAll('.ellipsis-container').forEach((ellipsisContainer) => {
            ellipsisContainer.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent click from bubbling to parent message container
                const message = this.closest('.message');
                message.classList.toggle('show-dropdown');
            });
        });

        // Close dropdown when clicking anywhere outside the message
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.dropdown-menu2').forEach(dropdown => {
                if (!dropdown.contains(event.target) && !dropdown.previousElementSibling.contains(event.target)) {
                    dropdown.style.display = 'none'; // Hide the dropdown if clicked outside
                    dropdown.previousElementSibling.classList.remove('active'); // Remove 'active' class
                }
            });
        });

        // Send the message when the Enter key is pressed (without Shift)
        const messageInput = document.getElementById('content');
        const sendButton = document.getElementById('sendbutton');
        const messageForm = document.getElementById('message-form');

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line from being added
                if (messageInput.value.trim() !== "") {
                    messageForm.submit(); // Submit the form to send the message
                }
            }
        });

        // Enable send button when there is text in the message input
        messageInput.addEventListener('input', function() {
            sendButton.disabled = messageInput.value.trim() === "";
        });

        // Open dark gray colour when dropdown box is open
        document.querySelectorAll('.ellipsis-container').forEach(ellipsisContainer => {
            ellipsisContainer.addEventListener('click', function(event) {
                // Prevent the click event from propagating further
                event.stopPropagation();

                // First, close any open dropdowns and reset their ellipses to the default state
                document.querySelectorAll('.ellipsis-container').forEach(container => {
                    if (container !== this) {
                        container.classList.remove('active'); // Remove 'active' class
                        const dropdownMenu = container.nextElementSibling;
                        dropdownMenu.style.display = 'none'; // Hide the dropdown menu
                    }
                });

                // Toggle the 'active' class on the clicked ellipsis container
                this.classList.toggle('active');

                // Toggle the display of the dropdown menu for the clicked ellipsis
                const dropdownMenu = this.nextElementSibling;
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
        });

        document.querySelectorAll('.delete-option').forEach(option => {
            option.addEventListener('click', function(event) {
                event.preventDefault();  // Prevent the default action of the delete link

                // Get the message ID from the clicked delete option
                const messageId = this.getAttribute('data-message-id');

                // Show the confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                modal.show();  // Show the modal

                // Set the message ID on the 'Confirm Delete' button
                document.getElementById('confirmDeleteButton').setAttribute('data-message-id', messageId);

                // Confirm delete action when clicking on the 'Confirm Delete' button
                document.getElementById('confirmDeleteButton').addEventListener('click', function() {
                    modal.hide();  // Hide the modal after deletion is confirmed
                    const messageId = this.getAttribute('data-message-id');
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`).closest('.message');
                    const preElement = messageElement.querySelector('pre');
                    preElement.innerHTML = "<i style='color: lightgray;'>This message has been deleted</i>";
                    const ellipsisContainer = messageElement.querySelector('.ellipsis-container');
                    ellipsisContainer.style.display = 'none';

                    fetch('/delete_message', {
                        method: 'POST',  // Use POST for modifying data
                        headers: {
                            'Content-Type': 'application/json',  // Tell the server we're sending JSON
                        },
                        body: JSON.stringify({
                            message_id: messageId  // Send the message ID as part of the request body
                        })
                    })
                    .then(response => response.json())  // Assuming the backend returns JSON
                    .then(data => {
                        if (data.success) {
                            // Optionally, remove the message from the UI if deletion is successful
                            document.querySelector(`[data-message-id='${messageId}']`).closest('.message').remove();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });


                });
            });
        });
        //Scroll to the bottom
        function scrollToBottom() {
            const messageBox = document.querySelector('.message-box');
            messageBox.scrollTop = messageBox.scrollHeight;
        }
        window.onload = function() {
            scrollToBottom();
        };
        //function to shorten text to ...
        function truncateName(name, maxLength) {
            if (name.length > maxLength) {
                return name.slice(0, maxLength) + "...";
            }
            return name;
        }
        //shortening usernames if they exceed 20 characters
        const userNames = document.querySelectorAll(".user_name111");
        for (let i = 0; i < userNames.length; i++) {
            const element = userNames[i];  // Get the current element in the loop
            const fullName = element.textContent;  // Get the current text of the element
            const truncatedName = truncateName(fullName, 20);  // Limit name to 20 characters (or any other number)
            element.textContent = truncatedName;  // Update the element's text with the truncated name
        }
        const chatContainer = document.querySelector(".forjavascript222");
        const userNames2 = chatContainer.textContent;
        const truncatedName2 = truncateName(userNames2, 60);
        chatContainer.textContent = truncatedName2;

        //user profile preview
        document.querySelector('.chat-container11').addEventListener('click', function() {
            // Open the modal
            const userProfileModal = new bootstrap.Modal(document.getElementById('userProfileModal'));
            userProfileModal.show();
        });

        document.getElementById('goToProfileButton').addEventListener('click', function() {
            window.location.href = `/profile/{{ selected_chat['receiver_id'] }}`;
        });

        document.getElementById('blockUserButton').addEventListener('click', function() {

        });
        document.getElementById('deletechat111').addEventListener('click', function () {
            const receiverId = this.getAttribute('data-receiver-id');
            const modalElement = document.getElementById('userProfileModal'); // Replace with your modal's ID
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement); // Get the Bootstrap modal instance
                modalInstance.hide(); // Hide the modal
            }
            fetch('/delete_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ receiver_id: receiverId }),
            })
            window.location.href = "/messages";
        });

        function limitDigits() {
            const input = document.getElementById("receiver_id");
            if (input.value.length > 15) {
                input.value = input.value.slice(0, 15);
            }
            input.value = input.value.replace(/\D/g, "");
        }

        let latestMessageContent = "";
        document.querySelectorAll('.edit-option').forEach(option => {
            option.addEventListener('click', function(event) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();

                const messageId = this.getAttribute('data-message-id');
                let messageContent = this.getAttribute('data-message-content');
                const messageInput = document.getElementById('editInput');
                const confirmEditButton = document.getElementById('confirmedit');

                messageInput.value = latestMessageContent || messageContent.trim();

                confirmEditButton.replaceWith(confirmEditButton.cloneNode(true));
                const newConfirmEditButton = document.getElementById('confirmedit');

                // Update the button state based on the input field
                const updateButtonState = function() {
                    const inputValue = messageInput.value.trim();  // Get the trimmed value of the input field
                    if (inputValue === messageContent.trim()) {
                        newConfirmEditButton.disabled = true;  // Disable button if input is same as original content
                        console.log("New and old message are the same");
                    } else if (inputValue) {
                        newConfirmEditButton.disabled = false;  // Enable the button if there's input
                        console.log("New message is new");
                    } else {
                        newConfirmEditButton.disabled = true;  // Disable button if input is empty
                        console.log("Empty message");
                    }
                };
                updateButtonState();
                messageInput.addEventListener('input', function() {
                    updateButtonState();
                });

                const newClickHandler = function(e) {
                    e.preventDefault();
                    const messageInputValue = messageInput.value.trim();
                    if (messageInputValue === "") {
                        return;
                    }
                    console.log("Message Input Value:", messageInput.value);
                    latestMessageContent = messageInputValue;
                    fetch('/edit_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messageId: messageId,
                            message: messageInput.value.trim()
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Response:', data);

                        // Update the DOM to show the new message content
                        const messageDiv = document.getElementById(messageId); // Find the message by its ID
                        if (messageDiv) {
                            const preTag = messageDiv.querySelector('pre'); // Find the <pre> tag inside the message div
                            if (preTag) {
                                preTag.textContent = messageInput.value.trim(); // Update the message content
                            }
                            const editCheckTag = messageDiv.querySelector('#editcheck');
                            // Add the "Edited" tag
                            if (!editCheckTag) {
                                const editedTag = document.createElement('div');
                                editedTag.classList.add('time', 'editTag');
                                editedTag.style.marginLeft = '94%';
                                editedTag.innerHTML = '<small>Edited</small>';
                                messageDiv.appendChild(editedTag); // Append the Edited tag
                            }
                        }

                        modal.hide(); // Close the modal
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                };

                // Re-attach the event listener to the new button
                newConfirmEditButton.addEventListener('click', newClickHandler);
            });
        });



    </script>
</body>

{% endblock %}
{% from "includes/_formHelper.html" import render_field %}